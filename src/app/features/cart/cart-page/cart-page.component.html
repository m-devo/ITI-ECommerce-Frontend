<app-header></app-header>

<!-- Loading  -->
<div *ngIf="(loading$ | async) && !cart" class="flex items-center justify-center min-h-screen">
  <div class="text-center">
    <mat-spinner diameter="50" class="mx-auto mb-4"></mat-spinner>
    <p class="text-gray-600 text-lg">Loading your cart...</p>
  </div>
</div>

<!-- Error -->
<div *ngIf="error && !(loading$ | async)" class="flex items-center justify-center min-h-screen">
  <mat-card class="max-w-md mx-auto text-center p-8">
    <mat-icon class="text-red-500 text-6xl mb-4">error</mat-icon>
    <h2 class="text-xl font-semibold text-gray-800 mb-2">Oops! Something went wrong</h2>
    <p class="text-gray-600 mb-6">{{ error }}</p>
    <button mat-raised-button color="primary" (click)="retryLoadCart()" class="w-full">
      <mat-icon>refresh</mat-icon>
      Try Again
    </button>
  </mat-card>
</div>

<!-- Cart  -->
<div *ngIf="cart && !error" class="container mx-auto px-4 py-8 max-w-7xl">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center">
      <mat-icon class="mr-3 text-blue-500">shopping_cart</mat-icon>
      Shopping Cart
      <span *ngIf="totalItems > 0" class="ml-3 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-red-600 rounded-full">
        {{ totalItems }}
      </span>
    </h1>
    <p class="text-gray-600" *ngIf="totalItems > 0">
      {{ totalItems }} {{ totalItems === 1 ? 'item' : 'items' }} â€¢ Total: {{ formatPrice(totalPrice) }}
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Cart Items  -->
    <div class="lg:col-span-2">


      <!-- Empty Cart -->
      <div *ngIf="!cart.items.length" class="text-center py-16">
        <mat-icon class="text-gray-400 text-8xl mb-4">shopping_bag</mat-icon>
        <h2 class="text-2xl font-semibold text-gray-700 mb-2">Your cart is empty</h2>
        <p class="text-gray-500 mb-6">Start adding some great books to your cart!</p>
        <button mat-raised-button color="primary" routerLink="/shop" class="px-8">
          <mat-icon>book</mat-icon>
          Browse Books
        </button>
      </div>

      <!-- Cart Items List -->
      <div *ngIf="cart.items.length" class="space-y-4">
        <!-- Cart Item -->
        <mat-card *ngFor="let item of cart.items; trackBy: trackByBookId" class="overflow-hidden">
          <mat-card-content class="p-4">
            <div class="flex flex-col md:flex-row items-center">
              <div class="w-24 h-32 md:w-32 md:h-40 mr-4 flex-shrink-0">
                <img
                  [src]="item.book.imagePath || 'assets/images/book-placeholder.png'"
                  [alt]="item.book.title || 'Book cover'"
                  class="w-full h-full object-cover rounded-lg shadow-sm"
                  onerror="this.src='assets/images/book-placeholder.png'"
                />
              </div>
              <div class="flex-grow">
                <h3 class="text-lg font-semibold text-gray-800">{{ item.book.title || 'Book not found' }}</h3>
                <p class="text-gray-600">{{ item.book.author || 'Unknown author' }}</p>
                <p class="text-gray-500 mt-2">Price: {{ formatPrice(item.book.price || 0) }}</p>
                <div class="mt-1">
                  <span *ngIf="item.book.stock < 10" class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full">
                    Only {{ item.book.stock }} left
                  </span>
                  <span *ngIf="item.book.stock >= 10" class="inline-flex items-center px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full">
                    In stock
                  </span>
                </div>
              </div>

              <!-- Quantity -->
              <div class="flex items-center space-x-2 mt-4 md:mt-0" *ngIf="item.book">
                <button
                  mat-mini-fab
                  color="primary"
                  (click)="decrementItem(item.book._id)"
                  [disabled]="!canDecrement(item.quantity) || (loading$ | async)">
                  <mat-icon>remove</mat-icon>
                </button>

                <span class="w-16 px-2 py-1 text-center border border-gray-300 rounded bg-gray-50">
                  {{ item.quantity }}
                </span>

                <button
                  mat-mini-fab
                  color="primary"
                  (click)="incrementItem(item.book._id)"
                  [disabled]="!canIncrement(item.book, item.quantity) || (loading$ | async)">
                  <mat-icon>add</mat-icon>
                </button>

                <button
                  mat-icon-button
                  color="warn"
                  (click)="removeItem(item.book._id)"
                  [disabled]="(loading$ | async)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div class="flex items-center space-x-4 mt-4 md:mt-0" *ngIf="!item.book">
                <button
                  mat-icon-button
                  color="warn"
                  (click)="removeItem($any(item.book)?._id || '')"
                  [disabled]="(loading$ | async)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <!-- Item total -->
              <div class="text-right ml-6">
                <p class="text-lg font-bold text-blue-500">
                  {{ formatPrice((item.book.price || 0) * item.quantity) }}
                </p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
        <div class="text-center pt-4">
          <button
            mat-stroked-button
            color="warn"
            (click)="clearCart()"
            [disabled]="(loading$ | async)">
            <mat-icon class="mr-2">clear_all</mat-icon>
            Clear Cart
          </button>
        </div>
      </div>
    </div>

    <!-- summary -->
    <div class="lg:col-span-1" *ngIf="cart.items.length">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Order Summary</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-4">
          <div class="space-y-4">
            <div class="flex justify-between border-b pb-2">
              <span>Subtotal</span>
              <span>{{ formatPrice(totalPrice) }}</span>
            </div>
            <div class="flex justify-between font-bold text-lg">
              <span>Total</span>
              <span class="text-blue-500">{{ formatPrice(totalPrice) }}</span>
            </div>
            <button
              mat-raised-button
              color="primary"
              class="w-full mt-4"
              [disabled]="(loading$ | async)"
              routerLink="/checkout">
              <mat-icon class="mr-2">shopping_cart_checkout</mat-icon>
              Checkout
            </button>
            <button
              mat-stroked-button
              color="primary"
              class="w-full"
              routerLink="/shop">
              <mat-icon class="mr-2">arrow_back</mat-icon>
              Continue Shopping
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<div *ngIf="(loading$ | async) && cart" class="fixed inset-0 bg-black bg-opacity-25 flex items-center justify-center z-50">
  <mat-spinner diameter="40"></mat-spinner>
</div>

<app-footer></app-footer>
