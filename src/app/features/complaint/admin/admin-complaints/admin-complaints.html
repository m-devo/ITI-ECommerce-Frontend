<app-adminlayout>
  <div class="container mx-auto px-4 py-12 mb-20">

    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-serif font-bold text-gray-800">Complaints Dashboard</h1>
        <p class="text-gray-500 text-sm mt-1">Monitor and resolve user issues efficiently.</p>
      </div>

      <div class="w-full md:w-64 relative">
        <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">filter_list</mat-icon>
        <select [formControl]="statusFilter"
                class="block w-full rounded-xl border-gray-200 pl-10 pr-4 py-2.5 shadow-sm focus:border-[#00BFC5] focus:ring-[#00BFC5] text-sm bg-white cursor-pointer">
          <option value="all">All Statuses</option>
          <option value="new">New</option>
          <option value="inProgress">In Progress</option>
          <option value="resolved">Resolved</option>
          <option value="closed">Closed</option>
        </select>
      </div>
    </div>

    <div class="bg-white shadow-sm border border-gray-200 rounded-2xl overflow-hidden">

      @if (isLoading) {
        <div class="flex justify-center items-center h-64">
          <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
        </div>
      }

      <table mat-table [dataSource]="dataSource" class="w-full">

        <ng-container matColumnDef="ticketId">
          <th mat-header-cell *matHeaderCellDef class="!font-bold !text-gray-700 !bg-gray-50"> Ticket ID </th>
          <td mat-cell *matCellDef="let row">
             <span class="font-mono text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200">
               #{{ row._id.slice(-6) }}
             </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef class="!font-bold !text-gray-700 !bg-gray-50"> User </th>
          <td mat-cell *matCellDef="let row">
            <div class="flex items-center gap-3 py-2">
              <div class="w-8 h-8 rounded-full bg-[#00BFC5]/10 text-[#00BFC5] flex items-center justify-center text-xs font-bold">
                {{ row.user.firstName.charAt(0) }}
              </div>
              <div>
                <p class="text-sm font-semibold text-gray-900">{{ row.user.firstName }} {{ row.user.lastName }}</p>
                <p class="text-xs text-gray-500">{{ row.user.email }}</p>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef class="!font-bold !text-gray-700 !bg-gray-50"> Status </th>
          <td mat-cell *matCellDef="let row">
            <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide"
                  [class]="row.status | statusBg">
              {{ row.status }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="details">
          <th mat-header-cell *matHeaderCellDef class="!font-bold !text-gray-700 !bg-gray-50"> Subject </th>
          <td mat-cell *matCellDef="let row" class="max-w-xs">
            <p class="text-sm text-gray-600 truncate" [matTooltip]="row.details">
              {{ row.details }}
            </p>
          </td>
        </ng-container>

        <ng-container matColumnDef="lastUpdated">
          <th mat-header-cell *matHeaderCellDef class="!font-bold !text-gray-700 !bg-gray-50"> Updated </th>
          <td mat-cell *matCellDef="let row" class="text-sm text-gray-500">
            {{ row.updatedAt | date:'MMM d, h:mm a' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="!font-bold !text-gray-700 !bg-gray-50 w-20"> </th>
          <td mat-cell *matCellDef="let row">
            <button mat-icon-button color="primary" (click)="navigateToDetails(row._id)"
                    matTooltip="View Details"
                    class="text-gray-400 hover:text-[#00BFC5] transition-colors">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50 transition-colors border-b border-gray-100"></tr>

        @if (!isLoading && dataSource.data.length === 0) {
          <tr class="mat-row">
            <td class="mat-cell p-12 text-center" [colSpan]="displayedColumns.length">
              <div class="flex flex-col items-center justify-center">
                <mat-icon class="text-gray-300 !text-5xl mb-2">inbox</mat-icon>
                <p class="text-gray-500 font-medium">No complaints found.</p>
              </div>
            </td>
          </tr>
        }
      </table>

      <mat-paginator [length]="totalComplaints" [pageSizeOptions]="[5, 10, 20]"
                     [pageSize]="10" showFirstLastButtons class="border-t border-gray-100">
      </mat-paginator>

    </div>
  </div>
</app-adminlayout>
