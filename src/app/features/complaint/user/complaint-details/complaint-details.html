<div class="container mx-auto px-4 py-16">

  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-serif font-bold text-gray-800">Complaint Details</h1>
    <button mat-stroked-button color="primary" routerLink="/user/complaints">
      <mat-icon>arrow_back_ios</mat-icon>
      Back to Complaints
    </button>
  </div>

  @if (isLoading | async) {
    <div class="flex justify-center items-center h-64">
      <mat-progress-spinner mode="indeterminate" [diameter]="50"></mat-progress-spinner>
    </div>
  } @else {

    @if (complaint$ | async; as complaint) {

      <div class="max-w-4xl mx-auto">

        <mat-card appearance="outlined" class="mb-6">
          <mat-card-header>
            <mat-card-title class="text-xl">Ticket #{{ complaint._id.slice(-6) }}</mat-card-title>
            <mat-card-subtitle>Submitted: {{ complaint.createdAt | date:'medium' }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content class="space-y-3">
            <p>
              <strong class="text-gray-600">Status:</strong>
              <mat-chip [color]="complaint.status | statusBg" selected class="ml-2">
                {{ complaint.status | titlecase }}
              </mat-chip>
            </p>
            <p class="pt-2">
              <strong class="text-gray-600">Original Message:</strong>
            </p>
            <p class="text-gray-800 bg-gray-50 p-3 rounded border text-sm">
              {{ complaint.details }}
            </p>
          </mat-card-content>
        </mat-card>

        <h2 class="text-xl font-bold text-gray-700 mb-4">Conversation</h2>
        <div class="bg-white shadow rounded-lg border">

          <div class="p-4 h-[450px] overflow-y-auto flex flex-col space-y-4 bg-gray-50">

            <div class="flex justify-end">
              <div class="bg-blue-600 text-white p-3 rounded-lg max-w-lg shadow-sm rounded-br-none">
                <p class="font-bold text-sm">You (Original Message)</p>
                <p class="mt-1 text-base">{{ complaint.details }}</p>
                <p class="text-xs text-blue-100 text-right mt-1">{{ complaint.createdAt | date:'short' }}</p>
              </div>
            </div>

            @for (reply of complaint.replies; track reply._id) {

              @if (reply.sender.role === 'admin') {
                <div class="flex justify-start">
                  <div class="bg-white border text-gray-900 p-3 rounded-lg max-w-lg shadow-sm rounded-bl-none">
                    <p class="font-bold text-sm">{{ reply.sender.firstName }} (Support Staff)</p>
                    <p class="mt-1 text-base">{{ reply.message }}</p>
                    <p class="text-xs text-gray-500 text-right mt-1">{{ reply.createdAt | date:'short' }}</p>
                  </div>
                </div>
              } @else {
                <div class="flex justify-end">
                  <div class="bg-blue-600 text-white p-3 rounded-lg max-w-lg shadow-sm rounded-br-none">
                    <p class="font-bold text-sm">You</p>
                    <p class="mt-1 text-base">{{ reply.message }}</p>
                    <p class="text-xs text-blue-100 text-right mt-1">{{ reply.createdAt | date:'short' }}</p>
                  </div>
                </div>
              }
            }
            </div>

          <div class="border-t p-4 bg-white">

            @if (complaint.status === 'closed' || complaint.status === 'resolved') {
              <p class="text-center text-gray-600 font-medium">This complaint is closed. You can no longer reply.</p>
            } @else {
              <form [formGroup]="replyForm" (ngSubmit)="submitReply()">
                <label for="replyMessage" class="sr-only">Write your reply...</label>
                <textarea id="replyMessage" formControlName="replyMessage" rows="3"
                          placeholder="Type your message here..."
                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                                 focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </textarea>

                @if (replyForm.get('replyMessage')?.touched && replyForm.get('replyMessage')?.hasError('required')) {
                  <p class="mt-1 text-sm text-red-600">Reply message is required.</p>
                }

                <div class="flex justify-end mt-3">
                  <button type="submit"
                          class="inline-flex items-center px-4 py-2 h-10 text-sm font-medium
                          text-white bg-blue-600 border border-transparent rounded-md shadow-sm
                          hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500
                                 disabled:opacity-50 disabled:cursor-not-allowed"
                          [disabled]="replyForm.invalid">
                    <mat-icon class="mr-2 -ml-1 h-5 w-5">send</mat-icon>
                    <span>Send Reply</span>
                  </button>
                </div>
              </form>
            }
            </div>

        </div>
      </div>

    } @else {
      <div class="text-center h-64 flex flex-col justify-center items-center">
        <mat-icon class="!text-7xl text-red-300">error_outline</mat-icon>
        <h3 class="text-2xl font-bold text-gray-700 mt-4">Complaint Not Found</h3>
        <p class="text-gray-500 mt-2">The requested complaint could not be loaded or does not exist.</p>
        <button mat-stroked-button color="primary" routerLink="/user/complaints" class="mt-4">
          Back to Complaints
        </button>
      </div>
    }
  }
</div>
