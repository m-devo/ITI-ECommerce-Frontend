<div class="py-6 bg-gray-50">
  <app-search></app-search>
</div>

<!-- Breadcrumb -->
<div
  class="relative bg-[url('https://susan-demo.myshopify.com/cdn/shop/files/bread.jpg?v=1567943980')] bg-cover bg-center py-24"
>
  <div class="absolute inset-0 bg-white/60"></div>

  <div class="relative max-w-7xl mx-auto px-6 text-center">
    <h1 class="text-4xl md:text-5xl font-bold text-primary mb-3">
      {{ book.title }}
    </h1>
    <div class="flex items-center justify-center gap-2 text-sm">
      <a routerLink="/" class="text-gray-600 hover:text-primary transition"
        >Home</a
      >
      <span class="text-gray-500">›</span>
      <span class="text-primary font-medium">{{ book.title }}</span>
    </div>
  </div>
</div>

<div class="bg-gray-50 p-6 md:p-12">
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-8 md:p-12">
    <!-- Book Details Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Image -->
      <div class="flex justify-center">
        <div class="relative">
          <img
            [src]="book.imagePath"
            [alt]="book.title"
            class="w-80 h-auto rounded-xl shadow-md border border-gray-200 object-cover"
            [class.opacity-50]="book.isDeleted || book.stock === 0"
          />
          <!-- Overlay for deleted/out of stock -->
          <div
            *ngIf="book.isDeleted || book.stock === 0"
            class="absolute inset-0 bg-black bg-opacity-50 rounded-xl flex items-center justify-center"
          >
            <span
              class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold text-lg"
            >
              {{ book.isDeleted ? 'UNAVAILABLE' : 'OUT OF STOCK' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Info -->
      <div class="space-y-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">{{ book.title }}</h1>

          <!-- Status Badge -->
          <div class="mt-2">
            <span
              *ngIf="book.isDeleted"
              class="inline-block px-3 py-1 bg-red-100 text-red-700 text-sm font-semibold rounded-full"
            >
              ⚠ This book is no longer available
            </span>
            <span
              *ngIf="!book.isDeleted && book.stock === 0"
              class="inline-block px-3 py-1 bg-red-100 text-red-700 text-sm font-semibold rounded-full"
            >
              ⚠ Currently out of stock
            </span>
            <span
              *ngIf="!book.isDeleted && book.stock > 0 && book.stock <= 5"
              class="inline-block px-3 py-1 bg-accent bg-opacity-20 text-accent text-sm font-semibold rounded-full"
            >
              ⚡ Only {{ book.stock }} left in stock
            </span>
          </div>
        </div>

        <p
          class="text-xl font-semibold text-primary"
          [class.line-through]="book.isDeleted"
          [class.text-gray-400]="book.isDeleted"
        >
          {{ book.price | currency }}
        </p>

        <!-- Rating -->
        <div class="flex gap-1">
          <span
            *ngFor="let star of [1,2,3,4,5]"
            [class.text-yellow-400]="star <= book.averageRating"
            [class.text-gray-300]="star > book.averageRating"
            class="text-xl"
            >★
          </span>
          <span class="text-sm text-gray-500 ml-2"
            >({{ book.reviewCount || 0 }} reviews)</span
          >
        </div>

        <!-- Description -->
        <p
          class="text-gray-700 leading-relaxed border-b border-gray-200 pb-4"
          [class.text-gray-400]="book.isDeleted"
        >
          {{ book.description }}
        </p>

        <!-- Info Table -->
        <table
          class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden"
        >
          <tbody>
            <tr
              *ngFor="let row of [
            {label:'Book Name', value:book.title},
            {label:'Author Name', value:book.author},
            {label:'Category', value:book.category},
            {label:'Publish Date', value:(book.uploadedAt | date:'yyyy/MM/dd')}
          ]"
              class="border-b last:border-none"
            >
              <td class="bg-gray-50 px-4 py-3 font-medium text-gray-900 w-40">
                {{ row.label }}
              </td>
              <td class="px-4 py-3 text-gray-700 bg-white">{{ row.value }}</td>
            </tr>
            <!-- Add Stock Status Row -->
            <tr>
              <td class="bg-gray-50 px-4 py-3 font-medium text-gray-900">
                Availability
              </td>
              <td class="px-4 py-3 bg-white">
                <span *ngIf="book.isDeleted" class="text-red-600 font-semibold">
                  Unavailable
                </span>
                <span
                  *ngIf="!book.isDeleted && book.stock === 0"
                  class="text-red-600 font-semibold"
                >
                  Out of Stock
                </span>
                <span
                  *ngIf="!book.isDeleted && book.stock > 0"
                  class="text-green-600 font-semibold"
                >
                  in stock
                </span>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Quantity + Add to Cart -->
        <div class="space-y-3 pt-3">
          <!-- Show controls only if book is available -->
          <div
            *ngIf="!book.isDeleted && book.stock > 0"
            class="flex items-center gap-4"
          >
            <!-- Qty Input -->
            <label class="flex items-center gap-2">
              <span class="text-sm font-medium text-gray-700">Qty:</span>
              <input
                type="number"
                [(ngModel)]="quantity"
                [max]="book.stock"
                min="1"
                (change)="updateQuantity()"
                class="w-16 px-3 py-2 border border-gray-300 rounded-lg text-center text-sm focus:ring-1 focus:ring-primary focus:outline-none"
              />
            </label>

            <!-- Add to Cart Button -->
            <button
              (click)="addToCart()"
              [class.bg-primary]="!isInCart"
              [class.bg-accent]="isInCart"
              class="flex-1 text-white px-6 py-3 rounded-lg font-medium hover:opacity-90 transition"
            >
              {{ isInCart ? 'Go to Cart' : 'Add to Cart' }}
            </button>
          </div>

          <!-- Disabled state for deleted book -->
          <div *ngIf="book.isDeleted" class="w-full">
            <button
              disabled
              class="w-full bg-gray-400 text-white px-6 py-3 rounded-lg font-medium cursor-not-allowed opacity-60"
            >
              Book Unavailable
            </button>
            <p class="text-sm text-red-600 mt-2">
              This book has been removed from our catalog and is no longer
              available for purchase.
            </p>
          </div>

          <!-- Disabled state for out of stock -->
          <div *ngIf="!book.isDeleted && book.stock === 0" class="w-full">
            <button
              disabled
              class="w-full bg-gray-400 text-white px-6 py-3 rounded-lg font-medium cursor-not-allowed opacity-60"
            >
              Out of Stock
            </button>
            <div
              class="flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg mt-2"
            >
              <svg
                class="w-5 h-5 text-blue-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <p class="text-sm text-blue-700 font-medium">
                This book is currently out of stock. Check back later or contact
                us for availability.
              </p>
            </div>
          </div>

          <!-- In Cart Message (only if available) -->
          <div
            *ngIf="isInCart && !book.isDeleted && book.stock > 0"
            class="p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2"
          >
            <svg
              class="w-4 h-4 text-green-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                clip-rule="evenodd"
              />
            </svg>
            <p class="text-sm text-green-700 font-medium">
              This book is in your cart ({{ quantity }} {{ quantity === 1 ?
              'copy' : 'copies' }})
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="pt-12">
    <mat-tab-group mat-align-tabs="center" class="shadow bg-white rounded-xl">
      <!-- Description Tab -->
      <mat-tab label="Description">
        <ng-template matTabContent>
          <div class="p-10 bg-gray-50 rounded-b-xl">
            <h2 class="text-3xl font-bold text-dark mb-6">Book Description</h2>

            <div class="flex items-center gap-2 mb-4">
              <span
                *ngFor="let star of [1,2,3,4,5]"
                [class.text-yellow-400]="star <= book.averageRating"
                [class.text-gray-300]="star > book.averageRating"
                class="text-xl"
                >★
              </span>
            </div>

            <p class="text-gray-700 text-lg leading-relaxed">
              {{ book.description }}
            </p>
          </div>
        </ng-template>
      </mat-tab>

      <!-- Reviews Tab -->
      <mat-tab label="Book Reviews">
        <ng-template matTabContent>
          <div class="p-8 bg-gray-50">
            <app-book-reviews
              *ngIf="book._id"
              [bookId]="book._id"
            ></app-book-reviews>
          </div>
        </ng-template>
      </mat-tab>

      <!-- Add Review Tab -->
      <mat-tab label="Add Review">
        <ng-template matTabContent>
          <div class="p-8 bg-gray-50">
            <app-add-reviews
              *ngIf="book._id"
              [bookId]="book._id"
            ></app-add-reviews>
          </div>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
