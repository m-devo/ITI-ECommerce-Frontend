<app-adminlayout>

<div class="bg-gray-800 text-white py-6 shadow-md">
  <div class="container mx-auto px-4">
    <h1 class="text-3xl font-serif font-bold">Live Chatboard</h1>
    @if (isConnecting()) {
      <p class="text-yellow-300">Connecting to chat server...</p>
    } @else {
      <p class="text-green-300">Connected</p>
    }
  </div>
</div>

<div class="container mx-auto px-4 py-10 mb-20">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

    <div class="md:col-span-1">
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title class="!flex !items-center !gap-2">
            Pending Users
            <mat-icon [matBadge]="pendingUsers().length" matBadgeColor="warn"
            [matBadgeHidden]="pendingUsers().length === 0">
              pending
            </mat-icon>
          </mat-card-title>
          <mat-card-subtitle>Users waiting for support</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-list role="list">
            @for (user of pendingUsers(); track user.customerId) {
              <mat-list-item role="listitem" class="!h-auto !py-2">
                <mat-icon matListItemIcon>account_circle</mat-icon>
                <div matListItemTitle class="!font-medium">{{ user.customerName }}</div>
                <div matListItemLine class="!text-xs !text-gray-500">ID: ...{{ user.customerId.slice(-6) }}</div>

                <button mat-flat-button color="primary" class="!ml-auto"
                        (click)="acceptChat(user.customerId)"
                        [disabled]="!!activeChat()">
                  Accept
                </button>
              </mat-list-item>
            } @empty {
              <p class="text-gray-500 p-4 text-center">No users waiting.</p>
            }
          </mat-list>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="md:col-span-2">
      @if (activeChat(); as chat) {
        <mat-card appearance="outlined" class="flex flex-col h-[600px]">
          <mat-card-header class="!bg-gray-50 !border-b">
            <mat-card-title>Chat with {{ chat.customerName }}</mat-card-title>
            <mat-card-subtitle>ID: ...{{ chat.customerId.slice(-6) }}</mat-card-subtitle>
            <button mat-stroked-button color="warn" class="!ml-auto" (click)="endChat()">
              <mat-icon>call_end</mat-icon>
              End Chat
            </button>
          </mat-card-header>

          <mat-card-content class="flex-1 overflow-y-auto p-4 bg-gray-100" #messagesContainer>
            <div class="flex flex-col gap-3">
              @for (msg of chat.messages; track $index) {
                @if (msg.isUser) {
                  <div class="flex justify-start">
                    <div class="bg-white border text-gray-900 p-3 rounded-lg max-w-lg shadow-sm rounded-bl-none">
                      <p class="font-bold text-sm">{{ msg.senderName }} (User)</p>
                      <p class="mt-1 text-base">{{ msg.message }}</p>
                    </div>
                  </div>
                } @else {
                  <div class="flex justify-end">
                    <div class="bg-cyan-600 text-white p-3 rounded-lg max-w-lg shadow-sm rounded-br-none">
                      <p class="font-bold text-sm">{{ msg.senderName }}</p>
                      <p class="mt-1 text-base">{{ msg.message }}</p>
                    </div>
                  </div>
                }
              }
            </div>
          </mat-card-content>

          <mat-card-actions class="p-4 border-t">
            <form [formGroup]="chatForm" (ngSubmit)="sendChatMessage()" class="flex w-full gap-2">
              <mat-form-field appearance="outline" class="flex-1">
                <mat-label>Type your reply...</mat-label>
                <input matInput formControlName="message" (keyup.enter)="sendChatMessage()">
              </mat-form-field>
              <button mat-flat-button color="primary" type="submit" [disabled]="chatForm.invalid">
                Send
              </button>
            </form>
          </mat-card-actions>
        </mat-card>
      } @else {
        <div class="h-[600px] flex flex-col items-center justify-center
                    border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
          <mat-icon class="!text-7xl text-gray-400">chat_bubble_outline</mat-icon>
          <p class="text-xl text-gray-500 mt-4">No active chat.</p>
          <p class="text-gray-400">Accept a user from the pending list to begin.</p>
        </div>
      }
    </div>

  </div>
</div>
</app-adminlayout>
